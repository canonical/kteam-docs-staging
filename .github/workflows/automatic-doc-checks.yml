name: Automatic doc checks

on:
  push:
    branches: [ main ]
  pull_request:
    paths:
      - 'docs/**'

  workflow_call:
  workflow_dispatch:

permissions:
  actions: read
  contents: read

env:
  GH_TOKEN: ${{ github.token }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  documentation-checks:
    uses: canonical/documentation-workflows/.github/workflows/documentation-checks.yaml@main
    with:
      working-directory: "docs"
      fetch-depth: 0

  download-spellcheck-logs:
    name: Download Spell Check Logs
    needs: documentation-checks
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Find child workflow run ID
        id: find_run
        run: |
          echo "Finding child reusable workflow run..."
          RUN_ID=$(gh run list \
            --json databaseId,event,headSha,workflowName \
            --jq "
              map(
                select(.event == \"workflow_call\") |
                select(.headSha == \"${{ github.sha }}\") |
                select(.workflowName == \"Automatic documentation checks\")
              )[0].databaseId
            ")
          
          echo "child_run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Download child logs
        run: |
          echo "Child run ID: ${{ steps.find_run.outputs.child_run_id }}"
          gh run download ${{ steps.find_run.outputs.child_run_id }} \
            --repo ${{ github.repository }} \
            -D logs

      - name: Extract only Spell Check logs
        run: |
          mkdir spellcheck
          find logs -type f -iname "*spell*" -exec cp {} spellcheck/ \;

      - name: Upload Spell Check logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: spellcheck-logs
          path: spellcheck
